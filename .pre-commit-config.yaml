# Pre-commit Hook Configuration
#
# Automated validation and linting for dotfiles repository
#
# Installation:
#   pip install pre-commit
#   # or
#   brew install pre-commit
#
# Setup:
#   ./scripts/setup-git-hooks.sh
#   # or manually
#   pre-commit install --hook-type pre-commit --hook-type pre-push
#
# Usage:
#   pre-commit run --all-files          # Run on all files
#   pre-commit run --files <file>...    # Run on specific files
#   pre-commit autoupdate               # Update hook versions
#
# Bypass (use sparingly):
#   git commit --no-verify              # Skip pre-commit hooks
#   SKIP=hook-id git commit             # Skip specific hook
#
# More info: https://pre-commit.com/

# Minimum version required
minimum_pre_commit_version: '3.0.0'

# Don't fail fast - run all hooks even if one fails
fail_fast: false

# Default settings for all repositories
default_install_hook_types: [pre-commit, pre-push]
default_stages: [pre-commit]

repos:
  # =============================================================================
  # Built-in Hooks (pre-commit framework)
  # =============================================================================
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v4.6.0
    hooks:
      # File formatting
      - id: trailing-whitespace
        name: Trim trailing whitespace
        args: [--markdown-linebreak-ext=md]
        exclude: |
          (?x)^(
            .*\.snap$|
            .*\.min\.(js|css)$
          )

      - id: end-of-file-fixer
        name: Fix end of files
        exclude: |
          (?x)^(
            .*\.snap$|
            .*\.min\.(js|css)$
          )

      - id: mixed-line-ending
        name: Fix mixed line endings
        args: [--fix=lf]

      # Security
      - id: check-added-large-files
        name: Check for large files
        args: [--maxkb=500]
        exclude: |
          (?x)^(
            .*\.png$|
            .*\.jpg$|
            .*\.jpeg$|
            .*\.gif$|
            .*\.pdf$|
            .*\.lock$
          )

      - id: detect-private-key
        name: Detect private keys
        exclude: |
          (?x)^(
            tests/fixtures/.*
          )

      - id: check-merge-conflict
        name: Check for merge conflicts
        args: [--assume-in-merge]

      # Syntax validation
      - id: check-yaml
        name: Check YAML syntax
        exclude: |
          (?x)^(
            .*\.sops\.yaml$|
            .*\.secrets\.yaml$
          )

      - id: check-json
        name: Check JSON syntax

      - id: check-toml
        name: Check TOML syntax

      - id: check-xml
        name: Check XML syntax

      # Code quality
      - id: check-case-conflict
        name: Check for case conflicts

      - id: check-symlinks
        name: Check for broken symlinks

      - id: destroyed-symlinks
        name: Detect destroyed symlinks

      - id: check-executables-have-shebangs
        name: Check executables have shebangs
        exclude: |
          (?x)^(
            bin/.local/bin/.*
          )

      - id: check-shebang-scripts-are-executable
        name: Check scripts are executable

  # =============================================================================
  # Shell Scripts (shellcheck)
  # =============================================================================
  - repo: https://github.com/shellcheck-py/shellcheck-py
    rev: v0.10.0.1
    hooks:
      - id: shellcheck
        name: Lint shell scripts with shellcheck
        args: [--severity=warning, --shell=bash]
        files: |
          (?x)^(
            .*\.sh$|
            .*\.bash$|
            scripts/.*|
            shared/.*\.sh$
          )
        exclude: |
          (?x)^(
            tests/.*|
            scratchpads/.*
          )

  # =============================================================================
  # Shell Scripts (shfmt)
  # =============================================================================
  - repo: https://github.com/scop/pre-commit-shfmt
    rev: v3.8.0-1
    hooks:
      - id: shfmt
        name: Format shell scripts with shfmt
        args: [-i, '2', -ci, -bn, -sr, -w]
        files: |
          (?x)^(
            .*\.sh$|
            .*\.bash$|
            scripts/.*|
            shared/.*\.sh$
          )
        exclude: |
          (?x)^(
            tests/.*|
            scratchpads/.*
          )

  # =============================================================================
  # Markdown Linting
  # =============================================================================
  - repo: https://github.com/DavidAnson/markdownlint-cli2
    rev: v0.13.0
    hooks:
      - id: markdownlint-cli2
        name: Lint markdown files
        args: [--config, markdown/.markdownlint-cli2.yaml]
        files: \.md$
        exclude: |
          (?x)^(
            scratchpads/.*|
            node_modules/.*|
            CHANGELOG\.md$
          )

  # =============================================================================
  # Git Configuration
  # =============================================================================
  - repo: https://github.com/jorisroovers/gitlint
    rev: v0.19.1
    hooks:
      - id: gitlint
        name: Lint git commit messages
        stages: [commit-msg]

  # =============================================================================
  # YAML Linting
  # =============================================================================
  - repo: https://github.com/adrienverge/yamllint
    rev: v1.35.1
    hooks:
      - id: yamllint
        name: Lint YAML files
        args: [--config-file, yamllint/.yamllint]
        files: |
          (?x)^(
            .*\.yaml$|
            .*\.yml$
          )
        exclude: |
          (?x)^(
            scratchpads/.*|
            .*\.sops\.yaml$|
            .*\.secrets\.yaml$
          )

  # =============================================================================
  # Custom Local Hooks (dotfiles-specific)
  # =============================================================================
  - repo: local
    hooks:
      # Validate dotfiles configuration
      - id: validate-config
        name: Validate dotfiles configuration
        entry: ./scripts/validate-config.sh
        language: script
        pass_filenames: false
        files: |
          (?x)^(
            .*\.fish$|
            .*\.zsh$|
            .*\.sh$|
            .*\.bash$|
            shared/abbreviations\.yaml$|
            shared/environment\.(sh|fish)$
          )
        exclude: |
          (?x)^(
            scratchpads/.*|
            tests/.*
          )

      # Run shell linting script
      - id: lint-shell
        name: Lint shell scripts (custom script)
        entry: ./scripts/lint-shell
        language: script
        pass_filenames: false
        files: |
          (?x)^(
            .*\.sh$|
            .*\.bash$|
            scripts/.*|
            shared/.*\.sh$
          )
        exclude: |
          (?x)^(
            tests/.*|
            scratchpads/.*
          )

      # Check for uncommitted generated files
      - id: check-generated-files
        name: Check generated abbreviations are up-to-date
        entry: bash -c 'cd shared && ./generate-all-abbr.sh && git diff --exit-code fish/.config/fish/abbreviations.fish zsh/.config/zsh-abbr/abbreviations.zsh docs/abbreviations.md'
        language: system
        pass_filenames: false
        files: shared/abbreviations\.yaml$

      # Verify Fish syntax
      - id: fish-syntax
        name: Check Fish shell syntax
        entry: fish --no-execute
        language: system
        files: \.fish$
        exclude: |
          (?x)^(
            scratchpads/.*|
            tests/.*
          )

      # Verify Zsh syntax
      - id: zsh-syntax
        name: Check Zsh shell syntax
        entry: zsh -n
        language: system
        files: \.zsh$
        exclude: |
          (?x)^(
            scratchpads/.*|
            tests/.*
          )

      # Check for TODO/FIXME/HACK markers
      - id: check-todos
        name: Check for TODO/FIXME markers
        entry: bash -c 'if grep -rn "TODO\|FIXME\|HACK\|XXX" --include="*.sh" --include="*.fish" --include="*.zsh" --exclude-dir=scratchpads --exclude-dir=tests .; then echo "⚠️  Found TODO/FIXME markers - review before committing"; exit 0; fi'
        language: system
        pass_filenames: false
        verbose: true
        stages: [pre-push]

      # Ensure no secrets in code
      - id: check-secrets
        name: Check for potential secrets
        entry: bash -c 'if grep -rniE "(password|secret|api[_-]?key|token|credentials)" --include="*.sh" --include="*.fish" --include="*.zsh" --exclude="*.example" --exclude-dir=scratchpads --exclude-dir=local --exclude-dir=tests . | grep -v "PASSWORD\|SECRET\|API_KEY\|TOKEN" | grep -v "# "; then echo "⚠️  Potential secrets detected - ensure they are in local/*.local files"; exit 1; fi'
        language: system
        pass_filenames: false
        stages: [pre-commit]

  # =============================================================================
  # Pre-push Hooks (more intensive checks)
  # =============================================================================
  - repo: local
    hooks:
      # Run test suite before push
      - id: run-tests
        name: Run test suite
        entry: ./scripts/run-tests --fast
        language: script
        pass_filenames: false
        stages: [pre-push]
        verbose: true

      # Full validation before push
      - id: full-validation
        name: Run full validation suite
        entry: ./scripts/validate-config.sh --quiet
        language: script
        pass_filenames: false
        stages: [pre-push]

# Configuration for specific hooks
# These can be overridden in .pre-commit-config.local.yaml

# vim: set filetype=yaml:
